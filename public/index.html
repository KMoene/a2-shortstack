<!doctype html>
<html lang="en">

<head>
  <title>CS4241 Assignment 2</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Playfair+Display">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono">
</head>

<body>
  <h1>Moene's Guest Book</h1>
  <img src="images/banner.jpg" alt="morgan hall">
  <h2 id="jswarning-h2">Warning: Javascript Disabled!</h2>
  <p id="jswarning-p">Seems like you disabled JavaScript in your browser settings or your browser does not support
    JavaScript.<br\>
      Please consult your browser's documentation or ask your administrator for assistant.</p>
    <div class="maingrid">
      <div class="nav-grid">
        <div id="nav-area">
          <a href="#" onclick="showNew()">Add</a> <a href="#" onclick="showMessages()">View/Edit</a> &nbsp; &nbsp;<div
            id="serv-conn" href="#">Please wait...</div>
        </div>
      </div>
      <div class="policy-grid">
        <h2>Policy</h2>
        <p>Avoid blame, speculation, and inflammatory language</p>
        <p>Do not mention someone else unless you have their permission</p>
        <p>Do not spam messages</p>
        <p>Absolutely no sexist, raciest, etc. messages.</p>
      </div>
      <div class="data-grid">
        <div id="entry-area" style="display: none;">
          <h2>Guest Book Entry</h2>
          <p>Thank you for visiting!</p>
          <p>Please sign my guest book before you leave.</p>
          <form action="">
            Name: <input title="Name" style="width: 60%;" type='text' id='name' value=""><br>
            Message: <input title="Message" style="width:60%;" type='text' id='message' value=""><br>
            <button id="newsub">submit</button>
          </form>
        </div>
        <div id="edit-area" style="display: none;">
          <h2>Entry Edit</h2>
          <p>Made a mistake? No worry! Edit your entry here.</p>
          <form action="">
            Name: <input title="Name" style="width: 60%;" type='text' id='edit-name' value=""><br>
            Message: <input title="Message" style="width:60%;" type='text' id='edit-message' value=""><br>
            <input style="display: none;" type="number" id='edit-mid' value=0>
            <button id="editsub">submit</button>
            <button id="editcan">cancel</button>
          </form>
        </div>
        <div id="delete-area" style="display: none;">
          <h2>Entry Delete</h2>
          <p>This message will be deleted permanently! Are you sure?</p>
          <form action="">
            <input style="display: none;" type="number" id='del-mid' value=0>
            <button id="delsub">delete</button>
            <button id="delcan">cancel</button>
          </form>
        </div>
        <div id="view-area" style="display: none;">
          <h2>Guest Messages</h2>
          <p>These are messages that leaved by my guests.</p>
          <div id="msglist" class="typewriter">
  
          </div>
        </div>
      </div>
    </div>


</body>
<script>

  const newsection = document.getElementById('entry-area');
  const viewsection = document.getElementById('view-area');
  const editsection = document.getElementById('edit-area');
  const deletesection = document.getElementById('delete-area');

  const submitnew = function (e) {
    // prevent default form action from being carried out
    e.preventDefault()

    const nameinput = document.querySelector('#name')
    const msginput = document.querySelector('#message')
    json = { name: nameinput.value, message: msginput.value, action: "new" }
    body = JSON.stringify(json)

    fetch('/submit', {
      method: 'POST',
      body
    })
      .then(function (response) {
        // do something with the reponse 
        console.log(response)
        document.getElementById('newsub').disabled = true;
        document.getElementById("newsub").textContent = "success!"
        setTimeout(function () {
          document.getElementById("name").value = ""
          document.getElementById("message").value = ""
          document.getElementById("newsub").disabled = false;
          document.getElementById("newsub").textContent = "submit"
        }, 700);
      })

    return false
  }

  const submitdelete = function (e) {
    // prevent default form action from being carried out
    e.preventDefault()

    const mid = document.querySelector('#del-mid')
    json = { action: "delete", mid: mid.value }
    body = JSON.stringify(json)

    fetch('/submit', {
      method: 'POST',
      body
    })
      .then(function (response) {
        // do something with the reponse 
        console.log(response)
        document.getElementById('delcan').disabled = true;
        document.getElementById("delsub").disabled = true;
        document.getElementById("delsub").textContent = "deleting..."
        setTimeout(function () {
          showMessages();
          document.getElementById('delcan').disabled = false;
          document.getElementById("delsub").disabled = false;
          document.getElementById("delsub").textContent = "delete"
        }, 700);
      })

    return false
  }

  const submitedit = function (e) {
    // prevent default form action from being carried out
    e.preventDefault()

    const nameinput = document.querySelector('#edit-name')
    const msginput = document.querySelector('#edit-message')
    const mid = document.querySelector('#edit-mid')
    json = { name: nameinput.value, message: msginput.value, action: "edit", mid: mid.value }
    body = JSON.stringify(json)

    fetch('/submit', {
      method: 'POST',
      body
    })
      .then(function (response) {
        // do something with the reponse 
        console.log(response)
        document.getElementById('editcan').disabled = true;
        document.getElementById("editsub").disabled = true;
        document.getElementById("editsub").textContent = "editing..."
        setTimeout(function () {
          showMessages();
          document.getElementById('editcan').disabled = false;
          document.getElementById("editsub").disabled = false;
          document.getElementById("editsub").textContent = "submit"
        }, 700);
      })

    return false
  }

  const formCancel = function (e) {
    e.preventDefault();
    showMessages();
    return false;
  }

  function editMsg(mid, name, msg) {
    console.log("edit " + mid)
    hideAllViews();
    document.getElementById("edit-mid").value = mid;
    document.getElementById("edit-name").value = name;
    document.getElementById("edit-message").value = msg;
    editsection.style.display = "block";
  }

  function deleteMsg(params) {
    console.log("delete " + params)
    hideAllViews();
    document.getElementById("del-mid").value = params;
    deletesection.style.display = "block";
  }

  function showNew() {
    hideAllViews();
    newsection.style.display = "block";
  }
  function showMessages() {
    hideAllViews();
    viewsection.style.display = "block";
  }

  function hideAllViews() {
    viewsection.style.display = "none";
    editsection.style.display = "none";
    newsection.style.display = "none";
    deletesection.style.display = "none";
  }

  function updateList(params) {
    //Update list view
    const msglist = document.getElementById('msglist');
    fetch('/getmsg', {
      method: 'GET'
    }).then(response => response.json())
      .then((json) => {
        //console.log(json)
        // do something with the reponse 
        msglist.innerHTML = ""
        json.forEach(element => {
          msglist.innerHTML += (element.name + " said: " + element.message + "   <a href=\"#\" onclick=\"editMsg(" + element.mid + ",'" + element.name + "','" + element.message + "')\">Edit</a> <a href=\"#\" onclick=\"deleteMsg(" + element.mid + ")\">Delete</a><br/>");
        });
      })
  }
  function timeoutfetch(url, timeout = 300) {
    return Promise.race([
      fetch(url),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('timeout')), timeout)
      )
    ]);
  }

  window.onload = function () {
    //If javascript is enabled, hide warning message
    const warningh2 = document.getElementById('jswarning-h2');
    const warningp = document.getElementById('jswarning-p');
    warningh2.hidden = true;
    warningp.hidden = true;

    newsection.style.display = "block";

    const newbutton = document.getElementById('newsub');
    newbutton.onclick = submitnew

    const editbutton = document.getElementById('editsub');
    editbutton.onclick = submitedit

    const deletebutton = document.getElementById('delsub');
    deletebutton.onclick = submitdelete

    const delcanbutton = document.getElementById('delcan');
    delcanbutton.onclick = formCancel
    const editcanbutton = document.getElementById('editcan');
    editcanbutton.onclick = formCancel

    var intervalId = setInterval(function () {
      //console.log("Pinging server...")
      const servconn = document.getElementById('serv-conn');

      timeoutfetch('/getmsg', 300) // throw after max 5 seconds timeout error
        .then((result) => {
          servconn.textContent = "✓ Server Online"
          servconn.style.fontSize = 8;
          servconn.style.color = "#22CC55"
          updateList();
        })
        .catch((e) => {
          //console.error(e)
          servconn.textContent = "✘ Server Unreachable!"
          servconn.style.color = "#ff0000"
        })
    }, 600);
  }


</script>

</html>